<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>kubectl-neat-for-web</title>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-4xl font-bold text-center text-blue-700 mb-2">kubectl-neat-for-web</h1>
    <p class="text-center text-sm text-gray-600 mb-6">
      üßπ A browser-based tool to clean up noisy <code>kubectl get ... -o yaml</code> outputs.
    </p>

    <div class="bg-yellow-100 border border-yellow-300 text-yellow-800 p-4 rounded mb-6 text-sm">
      ‚ö†Ô∏è This tool runs entirely in your browser. No files are uploaded. Safe for local use!
    </div>

    <div class="mb-4">
      <label class="block font-semibold mb-2">Select input mode:</label>
      <div class="flex gap-4">
        <label class="inline-flex items-center">
          <input type="radio" name="mode" value="paste" checked onchange="toggleInputMode()" class="mr-2" />
          Paste YAML
        </label>
        <label class="inline-flex items-center">
          <input type="radio" name="mode" value="upload" onchange="toggleInputMode()" class="mr-2" />
          Upload YAML files/folders
        </label>
      </div>
    </div>

    <div id="pasteContainer" class="mb-4">
      <label class="block font-semibold mb-2">Paste YAML content:</label>
      <textarea id="input" rows="10" class="w-full p-3 border rounded shadow" placeholder="Paste kubectl YAML here..."></textarea>
    </div>

    <div id="uploadContainer" class="mb-4 hidden">
      <label class="block font-semibold mb-2">Upload .yaml/.yml files or folders:</label>
      <div class="space-y-2">
        <div>
          <input type="file" id="fileInput" accept=".yaml,.yml" multiple class="border p-2 rounded bg-white w-full" />
          <p class="text-sm text-gray-600 mt-1">Select multiple YAML files</p>
        </div>
        <div>
          <input type="file" id="folderInput" webkitdirectory class="border p-2 rounded bg-white w-full" />
          <p class="text-sm text-gray-600 mt-1">Select a folder containing YAML files</p>
        </div>
      </div>
    </div>

    <button onclick="neat()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 font-semibold mb-6">
      üßπ Neaten
    </button>

    <div>
      <label class="block font-semibold mb-2">Neatened Output:</label>
      <textarea id="output" rows="15" class="w-full p-3 border rounded shadow bg-gray-50" placeholder="Result appears here..."></textarea>
    </div>

    <footer class="text-center mt-8 text-sm text-gray-500">
      Source on GitHub:
      <a href="https://github.com/phamthainb/kubectl-neat-for-web" target="_blank" class="text-blue-500 hover:underline">
        https://github.com/phamthainb/kubectl-neat-for-web
      </a>
    </footer>
  </div>

  <script>
    function toggleInputMode() {
      const mode = document.querySelector('input[name="mode"]:checked').value;
      document.getElementById("pasteContainer").classList.toggle("hidden", mode !== "paste");
      document.getElementById("uploadContainer").classList.toggle("hidden", mode !== "upload");
    }

    function processFiles(files) {
      const yamlFiles = Array.from(files).filter(file => 
        file.name.toLowerCase().endsWith('.yaml') || 
        file.name.toLowerCase().endsWith('.yml')
      );
      
      if (yamlFiles.length === 0) {
        alert('No YAML files found in selection.');
        return;
      }

      let combinedContent = '';
      let processedCount = 0;
      
      yamlFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function (e) {
          if (combinedContent && e.target.result.trim()) {
            combinedContent += '\n---\n';
          }
          combinedContent += e.target.result;
          processedCount++;
          
          // Update input field when all files are processed
          if (processedCount === yamlFiles.length) {
            document.getElementById("input").value = combinedContent;
          }
        };
        reader.onerror = function() {
          console.error(`Error reading file: ${file.name}`);
          processedCount++;
          if (processedCount === yamlFiles.length) {
            document.getElementById("input").value = combinedContent;
          }
        };
        reader.readAsText(file);
      });
    }

    document.getElementById("fileInput").addEventListener("change", function (event) {
      processFiles(event.target.files);
    });

    document.getElementById("folderInput").addEventListener("change", function (event) {
      processFiles(event.target.files);
    });

    function neat() {
      const inputText = document.getElementById("input").value;
      let output = "";

      try {
        const documents = jsyaml.loadAll(inputText);
        const cleanedDocs = documents.map(doc => stripFields(doc));
        output = cleanedDocs.map(doc => jsyaml.dump(doc, { noRefs: true })).join('---\n');
      } catch (err) {
        output = "‚ùå Error parsing YAML: " + err.message;
      }

      document.getElementById("output").value = output;
    }

    function stripFields(obj) {
      const skipMetadata = [
        "creationTimestamp", "resourceVersion", "selfLink",
        "uid", "generation", "managedFields"
      ];

      if (typeof obj !== "object" || obj === null) return obj;

      const newObj = Array.isArray(obj) ? [] : {};
      for (const key in obj) {
        if (
          key === "status" ||
          (key === "metadata" && typeof obj[key] === "object")
        ) {
          if (key === "metadata") {
            newObj[key] = {};
            for (const metaKey in obj[key]) {
              if (!skipMetadata.includes(metaKey)) {
                newObj[key][metaKey] = stripFields(obj[key][metaKey]);
              }
            }
          }
        } else if (key !== "status") {
          newObj[key] = stripFields(obj[key]);
        }
      }
      return newObj;
    }
  </script>
</body>
</html>
